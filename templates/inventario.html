{% extends "base.html" %}
{% block content %}
<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>üìã Inventario</h2>
        <p class="text-muted mb-0">Lista de productos disponibles</p>
    </div>
    <div class="d-flex gap-2">
        <a href="{{ url_for('transformaciones') }}" class="btn btn-warning">üîÑ Transformaciones</a>
        <button class="btn btn-outline-primary" onclick="toggleStats()">üìä Estad√≠sticas</button>
        <button class="btn btn-success" onclick="toggleFormProducto()">‚ûï Nuevo Producto</button>
    </div>
</div>

<div id="form-nuevo-producto" class="card mb-4 p-3" style="display:none;">
    <h5 class="card-title">Nuevo Producto</h5>
    <div class="row g-2">
        <div class="col-md-3">
            <input id="prod_nombre" class="form-control mb-1" placeholder="Nombre del producto" required>
        </div>
        <div class="col-md-2">
            <input id="prod_stock" type="number" class="form-control mb-1" placeholder="Stock" min="0" required>
        </div>
        <div class="col-md-2">
            <input id="prod_costo" type="number" class="form-control mb-1" placeholder="Costo" min="0" step="0.01" required>
        </div>
        <div class="col-md-3">
            <input id="prod_precio" type="number" class="form-control mb-1" placeholder="Precio de Venta" min="0" step="0.01" required>
        </div>
        <div class="col-md-2 d-flex">
            <button type="button" class="btn btn-primary w-100" onclick="guardarProducto()">Guardar</button>
        </div>
    </div>
</div>

<div id="stats-panel" class="card mb-4" style="display:none;">
    <div class="card-body">
        <div class="row text-center">
            <div class="col-md-3">
                <div class="bg-primary text-white p-3 rounded">
                    <h5 id="total-productos">0</h5>
                    <small>Total Productos</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="bg-success text-white p-3 rounded">
                    <h5 id="stock-total">0</h5>
                    <small>Stock Total</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="bg-warning text-white p-3 rounded">
                    <h5 id="productos-bajo-stock">0</h5>
                    <small>Stock Bajo (&lt;10)</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="bg-info text-white p-3 rounded">
                    <h5 id="valor-inventario">$0</h5>
                    <small>Valor Inventario</small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4 p-3">
    <div class="row g-2">
        <div class="col-md-4">
            <input type="text" id="buscar" class="form-control" placeholder="üîç Buscar producto...">
        </div>
        <div class="col-md-3">
            <select id="filtro-stock" class="form-select">
                <option value="">Todos los stocks</option>
                <option value="alto">Stock alto (&gt;50)</option>
                <option value="medio">Stock medio (11-50)</option>
                <option value="bajo">Stock bajo (&lt;=10)</option>
                <option value="agotado">Sin stock (0)</option>
            </select>
        </div>
        <div class="col-md-3">
            <select id="ordenar" class="form-select">
                <option value="nombre">Ordenar por nombre</option>
                <option value="stock-desc">Stock mayor a menor</option>
                <option value="stock-asc">Stock menor a mayor</option>
                <option value="costo-desc">Costo mayor a menor</option>
                <option value="costo-asc">Costo menor a mayor</option>
            </select>
        </div>
        <div class="col-md-2">
            <button class="btn btn-outline-secondary w-100" onclick="limpiarFiltros()">üóëÔ∏è Limpiar</button>
        </div>
    </div>
</div>

<div class="card">
    <div class="table-responsive">
        <table class="table table-hover mb-0" id="tabla-inventario">
            <thead class="table-dark">
                <tr>
                    <th>Producto</th>
                    <th>Stock</th>
                    <th>Costo</th>
                    <th>Precio de Venta</th>
                    <th>Valor Total</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for p in productos %}
                <tr data-producto-id="{{ p['id'] }}">
                    <td><strong>{{ p["nombre"] }}</strong></td>
                    <td>
                        <span class="badge {% if p['stock'] <= 0 %}bg-danger{% elif p['stock'] <= 10 %}bg-warning{% elif p['stock'] <= 50 %}bg-info{% else %}bg-success{% endif %}">
                            {{ p["stock"] }}
                        </span>
                    </td>
                    <td>${{ "%.2f"|format(p["costo"]) }}</td>
                    <td>${{ "%.2f"|format(p["precio"]) }}</td>
                    <td><strong>${{ "%.2f"|format(p["stock"] * p["costo"]) }}</strong></td>
                    <td>
                        {% if p['stock'] <= 0 %}
                            <span class="badge bg-danger">Agotado</span>
                        {% elif p['stock'] <= 10 %}
                            <span class="badge bg-warning">Stock Bajo</span>
                        {% elif p['stock'] <= 50 %}
                            <span class="badge bg-info">Stock Medio</span>
                        {% else %}
                            <span class="badge bg-success">Stock Alto</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick='editarProducto({{ p["id"] }}, "{{ p["nombre"] }}", {{ p["stock"] }}, {{ p["costo"] }}, {{ p["precio"] }})'>‚úèÔ∏è Editar</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="eliminarProducto({{ p['id'] }}, '{{ p['nombre'] }}')">üóëÔ∏è</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="mt-3 text-muted">
    <small>Total de registros: <span id="total-registros">{{ productos|length }}</span></small>
</div>

<!-- Modal Editar Producto -->
<div class="modal fade" id="modalEditarProducto" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚úèÔ∏è Editar Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit_producto_id">
                <div class="mb-3">
                    <label class="form-label">Nombre del Producto *</label>
                    <input type="text" class="form-control" id="edit_nombre" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Stock *</label>
                    <input type="number" class="form-control" id="edit_stock" min="0" step="0.01" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Costo *</label>
                    <input type="number" class="form-control" id="edit_costo" min="0" step="0.01" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Precio de Venta *</label>
                    <input type="number" class="form-control" id="edit_precio" min="0" step="0.01" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarEdicion()">üíæ Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let modalEditar;

document.addEventListener('DOMContentLoaded', function(){
    modalEditar = new bootstrap.Modal(document.getElementById('modalEditarProducto'));
    actualizarEstadisticas();
    configurarFiltros();
});

// FILTROS Y ORDENAMIENTO
function configurarFiltros(){
    document.getElementById('buscar').addEventListener('input', filtrarTabla);
    document.getElementById('filtro-stock').addEventListener('change', filtrarTabla);
    document.getElementById('ordenar').addEventListener('change', ordenarTabla);
}

function filtrarTabla(){
    const buscar = document.getElementById('buscar').value.toLowerCase();
    const filtroStock = document.getElementById('filtro-stock').value;
    const filas = document.querySelectorAll('#tabla-inventario tbody tr');
    let visibles = 0;
    filas.forEach(fila=>{
        const producto = fila.querySelector('td:first-child strong').textContent.toLowerCase();
        const stock = parseInt(fila.querySelector('.badge').textContent);
        let mostrar = true;
        if(buscar && !producto.includes(buscar)) mostrar=false;
        if(filtroStock){
            switch(filtroStock){
                case 'alto': mostrar = mostrar && stock>50; break;
                case 'medio': mostrar = mostrar && stock>=11 && stock<=50; break;
                case 'bajo': mostrar = mostrar && stock>0 && stock<=10; break;
                case 'agotado': mostrar = mostrar && stock===0; break;
            }
        }
        fila.style.display = mostrar?'':'none';
        if(mostrar) visibles++;
    });
    document.getElementById('total-registros').textContent = visibles;
}

function ordenarTabla(){
    const orden = document.getElementById('ordenar').value;
    const tbody = document.querySelector('#tabla-inventario tbody');
    const filas = Array.from(tbody.querySelectorAll('tr'));
    filas.sort((a,b)=>{
        switch(orden){
            case 'nombre': return a.querySelector('strong').textContent.localeCompare(b.querySelector('strong').textContent);
            case 'stock-desc': return parseInt(b.querySelector('.badge').textContent)-parseInt(a.querySelector('.badge').textContent);
            case 'stock-asc': return parseInt(a.querySelector('.badge').textContent)-parseInt(b.querySelector('.badge').textContent);
            case 'costo-desc': return parseFloat(b.cells[2].textContent.replace('$',''))-parseFloat(a.cells[2].textContent.replace('$',''));
            case 'costo-asc': return parseFloat(a.cells[2].textContent.replace('$',''))-parseFloat(b.cells[2].textContent.replace('$',''));
        }
    });
    filas.forEach(f=>tbody.appendChild(f));
}

function limpiarFiltros(){
    document.getElementById('buscar').value='';
    document.getElementById('filtro-stock').value='';
    document.getElementById('ordenar').value='nombre';
    filtrarTabla();
    ordenarTabla();
}

// ESTAD√çSTICAS
function toggleStats(){
    const panel=document.getElementById('stats-panel');
    panel.style.display=(panel.style.display==='none')?'block':'none';
    actualizarEstadisticas();
}

function actualizarEstadisticas(){
    const filas = document.querySelectorAll('#tabla-inventario tbody tr');
    let total=0, stockTotal=0, bajo=0, valor=0;
    filas.forEach(f=>{
        if(f.style.display==='none') return;
        total++;
        const stock=parseInt(f.querySelector('.badge').textContent);
        const costo=parseFloat(f.cells[2].textContent.replace('$',''));
        stockTotal+=stock;
        valor+=stock*costo;
        if(stock<=10) bajo++;
    });
    document.getElementById('total-productos').textContent=total;
    document.getElementById('stock-total').textContent=stockTotal.toLocaleString();
    document.getElementById('productos-bajo-stock').textContent=bajo;
    document.getElementById('valor-inventario').textContent='$'+valor.toFixed(2);
}

// NUEVO PRODUCTO
function toggleFormProducto() {
    const form = document.getElementById("form-nuevo-producto");
    form.style.display = (form.style.display === 'none') ? 'block' : 'none';
}

async function guardarProducto() {
    const nombre = document.getElementById("prod_nombre").value.trim();
    const stock = document.getElementById("prod_stock").value;
    const costo = document.getElementById("prod_costo").value;
    const precio = document.getElementById("prod_precio").value;

    if (!nombre || !stock || !costo || !precio) {
        alert('Todos los campos son obligatorios.');
        return;
    }

    const payload = { nombre, stock, costo, precio };

    try {
        const res = await fetch("{{ url_for('add_producto') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.success) {
            alert(`‚úÖ Producto "${nombre}" agregado con √©xito.`);
            location.reload();
        } else {
            alert("‚ùå Error: " + data.error);
        }
    } catch (err) {
        alert("‚ùå Error de conexi√≥n: " + err.message);
    }
}

// EDITAR PRODUCTO
function editarProducto(id, nombre, stock, costo, precio) {
    document.getElementById('edit_producto_id').value = id;
    document.getElementById('edit_nombre').value = nombre;
    document.getElementById('edit_stock').value = stock;
    document.getElementById('edit_costo').value = costo;
    document.getElementById('edit_precio').value = precio;
    modalEditar.show();
}

async function guardarEdicion() {
    const id = document.getElementById('edit_producto_id').value;
    const nombre = document.getElementById('edit_nombre').value.trim();
    const stock = document.getElementById('edit_stock').value;
    const costo = document.getElementById('edit_costo').value;
    const precio = document.getElementById('edit_precio').value;

    if (!nombre || !stock || !costo || !precio) {
        alert('Todos los campos son obligatorios.');
        return;
    }

    const payload = { nombre, stock, costo, precio };

    try {
        const res = await fetch(`/update_producto/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.success) {
            alert(`‚úÖ Producto actualizado correctamente`);
            modalEditar.hide();
            location.reload();
        } else {
            alert("‚ùå Error: " + data.error);
        }
    } catch (err) {
        alert("‚ùå Error de conexi√≥n: " + err.message);
    }
}

// ELIMINAR PRODUCTO
async function eliminarProducto(id, nombre) {
    if (!confirm(`¬øEliminar el producto "${nombre}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
        return;
    }

    try {
        const res = await fetch(`/delete_producto/${id}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        if (data.success) {
            alert(`‚úÖ Producto "${nombre}" eliminado correctamente`);
            location.reload();
        } else {
            alert("‚ùå Error: " + data.error);
        }
    } catch (err) {
        alert("‚ùå Error de conexi√≥n: " + err.message);
    }
}
</script>

<style>
.badge{font-size:.875rem;}
.table th{border-top:none;}
.card{box-shadow:0 .125rem .25rem rgba(0,0,0,.075);border:1px solid rgba(0,0,0,.125);}
.page-header h2{color:#495057;}
.btn-outline-primary:hover,.btn-outline-info:hover{color:white;}
#stats-panel .rounded{border-radius:.5rem !important;}
.table-hover tbody tr:hover{background-color:rgba(0,0,0,.025);}
</style>
{% endblock %}
